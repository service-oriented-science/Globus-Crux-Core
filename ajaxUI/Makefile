#
# PLEASE CHANGE PORT AND HOSTNAME 
#
SERVER_PORT=18998
#Linux
SERVER_HOSTNAME=$(shell hostname -f)
#OSX
#SERVER_HOSTNAME=$(shell hostname)

#deploy the agent and mediator in two seperated host
#EXT_SERVER_HOSTNAME=lily01.rit.edu
#EXT_SERVER_PORT=8998
#when deployed in the same host
EXT_SERVER_HOSTNAME=${SERVER_HOSTNAME}
EXT_SERVER_PORT=${SERVER_PORT}

#URL to deploy javascript library document
JSDOC_URI=lily01.rit.edu:/usr/local/tomcat/apache-tomcat-6.0.14/webapps/grid/jscogdoc/jsdoc/

#EDITOR=emacs
EDITOR=vi

######################################################################
# Location of the password file

PASSWD_FILE=./users.cyberaide

######################################################################
#
# DO NOT CHANGE FROM HERE ON
#
#

serveraddr=http://${SERVER_HOSTNAME}:${SERVER_PORT}/mediator
dummyjob=dummyjob

help:
	@echo "=============================================================="
	@echo "OPTIONS"
	@echo "  mediator - compile the mediator code and run the mediator"
	@echo "  mediator-build - compile the mediator code"
	@echo "  mediator-run - start the mediator"
	@echo "  mediator-add-user - adds a user"
	@echo ""
	@echo "  agent - compile and run the agent"
	@echo "  agent-pom - generate pom.xml file for agent"
	@echo "  agent-build - compile the agent code"
	@echo "  agent-aar - build the axis2 aar file"
	@echo ""
	@echo "  client-jsdoc - generate javascript API document"
	@echo "  jsdoc-site-deploy - publish the jsdoc to some site"
	@echo ""	
	@echo "  test-msg-publish - publish msg for activemq javascript client test. An Activemq broker must be started beforehand"
	@echo ""
	@echo "  clean - clean all"
	@echo "  clean-mediator - clean stuffs generated by mediator"
	@echo "  clean-agent - clean stuffs generated by agent"
	@echo "  clean-client - clean client side generated stuffs"
	@echo "=============================================================="

mediator: mediator-build mediator-run

mediator-edit-user:
	${EDITOR} ${PASSWD_FILE}

mediator-build:
	chmod go-rw ${PASSWD_FILE}
	cd mediator; mvn install; cd ..

mediator-run:
	@echo "---------------------------------"
	@echo "Deploying server on ${serveraddr}"
	@echo "---------------------------------"
	chmod go-rw ${PASSWD_FILE}
	cp ${PASSWD_FILE} ~/.cyberaide.users
	cd mediator; mvn exec:java -Dexec.mainClass=org.cyberaide.ws.mediator.CogMediator -Dexec.args=${serveraddr}; cd ..

mediator-add-user:
	echo "PLEASE STOP THE SERVER FIRST, TODO: To be done automatically"
	make -f Makefile mediator-edit-user
	echo "In future this simple edit may be alternatively modified via a GUI"

agent: agent-pom agent-build

agent-build:
	#mkdir -p ./agent/src/main/wsdl; cp ./mediator/src/main/wsdl/mediatorService.wsdl ./agent/src/main/wsdl/mediatorService.wsdl; 
	cd agent; mvn generate-sources; mvn install; cd ..

#agent-aar:
#	cd agent; mvn axis2-aar:aar; cd ..

agent-pom:
	cd agent; cp pom.xml.in pom.xml; perl -pi -e 's/SERVERADDRESS/http:\/\/${EXT_SERVER_HOSTNAME}:${EXT_SERVER_PORT}/g' pom.xml; cd ..

client-jsdoc:
	cd client; perl bin/JSDoc-1.10.2/jsdoc.pl cogkit-0.3.js; cd ..

jsdoc-site-deploy:
	cd client; scp -r js_docs_out/* ${JSDOC_URI}; cd ..

clean: clean-mediator clean-agent clean-client clean-test

clean-mediator:
	cd mediator; mvn clean; rm -rf ./src/main/wsdl; cd ..

clean-agent:
	cd agent; mvn clean; rm -rf pom.xml; cd ..
	
clean-client:
	cd client; rm -rf ./js_docs_out/; cd ..

clean-test:
	cd test; mvn clean; cd ..

#activemq broker must to be started before this
test-msg-publish:   
	cd test; mvn install; mvn exec:java -Dexec.mainClass=test.MsgPublisher; cd ..
#
# END OF THE MAKEFILE
#
######################################################################


